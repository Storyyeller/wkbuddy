<html>
    <meta charset="utf-8">
    <head>
        <title>Wanikani review accuracy by SRS stage</title>
        <h2>Wanikani review accuracy by SRS stage</h2>
    </head>
    <body>
        <form id="key-input-form" hidden>
            <label>Enter your Wanikani APIv2 key:<br>
                <input id="key-input" type=text
                    pattern="[\da-f]{8}-[\da-f]{4}-[\da-f]{4}-[\da-f]{4}-[\da-f]{12}"
                    placeholder="01234567-89ab-cdef-0123-456789abcdef" required>
            </label>
            <input type=submit value="Calculate">
        </form>

        <pre id="progress" hidden>Loading data: </pre>
        <pre id="results"></pre>
    </body>
</html>

<script type="text/javascript">
'use strict';
const {log, error, trace, assert} = console;

function get_api_key() {
    return new Promise((resolve, reject) => {
        const saved = localStorage.getItem('api-key');
        if (saved) {return resolve(saved);}

        const form = document.getElementById('key-input-form');
        form.hidden = false;
        form.addEventListener('submit', e => {
            e.preventDefault();
            const key = document.getElementById('key-input').value;
            form.hidden = true;
            form.disabled = true;

            localStorage.setItem('api-key', key);
            resolve(key);
        }, {once: true});
    });
}

const progress = document.getElementById('progress');
function append_progress(s) {
    progress.appendChild(document.createTextNode(s));
}

const worker = new Worker('worker.js');
worker.addEventListener('message', e => {
    log('got message from worker', e.data);
    switch (e.data[0]) {
        case 'progress':
            append_progress('+');
            break;
        case 'result':
            progress.hidden = true;
            processPage(...e.data[1]);
            break;
    }
});
get_api_key().then(key => {
    progress.hidden = false;
    worker.postMessage([key, ['subjects', 'reviews']]);
}).catch(e => {
    error('Caught error', e);
    progress.textContent = 'Oh dear, an error has occured!';
    progress.hidden = false;
});

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
const STAGES = ['Overall', 'Apprentice 1', 'Apprentice 2', 'Apprentice 3', 'Apprentice 4', 'Guru 1', 'Guru 2', 'Master', 'Enlightened', 'Burned'];
function processPage(subjects, reviews) {
    const zeros = [0,0,0,0,0,0,0,0,0];
    const counts = {
        radical: {num: [...zeros], den: [...zeros]},
        kanji: {num: [...zeros], den: [...zeros]},
        vocabulary: {num: [...zeros], den: [...zeros]},
    };

    let total = 0;
    let total_correct = 0;
    for (const [id, data] of reviews) {
        const {type, level} = subjects.get(data.subject_id);
        assert(counts[type]);

        const srs = data.starting_srs_stage;
        const correct = !(data.incorrect_reading_answers + data.incorrect_meaning_answers);

        total++;
        counts[type].den[0]++;
        counts[type].den[srs]++;
        if (correct) {
            total_correct++;
            counts[type].num[0]++;
            counts[type].num[srs]++;
        }
    }

    const out = document.getElementById('results');
    const write = s => out.appendChild(document.createTextNode(s));
    for (const [key, {num, den}] of Object.entries(counts)) {
        write(`\n${key}:\n`);
        for (let i = 0; i < num.length; ++i) {
            if (!num[i]) {break;}
            write(`${STAGES[i]}: ${100*num[i]/den[i]}% (${num[i]}/${den[i]})\n`);
        }
    }
    write(`\nOverall accuracy: ${100*total_correct/total}% (${total_correct}/${total})`);

}
</script>
