<html>
    <meta charset="utf-8">
    <head>
        <title>Daily summary</title>
        <h2>Daily summary</h2>
    </head>
    <body>
        <form id="key-input-form" hidden>
            <label>Please enter your Wanikani APIv2 key:<br>
                <input id="key-input" type=text
                    pattern="[\da-f]{8}-[\da-f]{4}-[\da-f]{4}-[\da-f]{4}-[\da-f]{12}"
                    placeholder="01234567-89ab-cdef-0123-456789abcdef" required>
            </label>
            <input type=submit value="Calculate">
        </form>
        <pre id="progress" hidden>Loading data: </pre>
        <pre id="results"></pre>
    </body>
</html>

<script src="storage_wrapper.js"></script>


<script type="text/javascript">
'use strict';
const {log, error, trace, assert} = console;


fetch_data(['assignments', 'reviews', 'subjects']).then(
    processPage
).catch(e => {
    error('Caught error', e);
    progress.textContent = 'Oh dear, an error has occured!';
    progress.hidden = false;
});


const prevburned_set = new Set([453,457,452,448,441,445,440,449,455,454,456,444,446,442,443,450,451,447,2497,2504,2505,2475,3402,2482,2473,2474,2476,2467,2468,2477,2486,2487,2488,2480,2481,2498,2503,2493,2494,2496,2485,7560,2469,2470,2499,2500,2502,2489,2490,2491,2492,2506,465,467,468,471,476,478,483,856,8733,2484,463,474,462,473,488,470,7515,7562,7563,7614,7616,464,485,487,2527,2529,2530,2531,458,477,481,480,491,472,494,2519,466,469,475,2517,2518,7517,460,492,461,490,459,484,486,482,489,479,2556,2557,2509,2510,2567,2516,2547,2512,2513,2514,2561,2549,2569,2570,2540,2559,8693,2550,2551,2520,2521,2524,2525,2526,2537,2538,2539,2511,2508,2532,2533,2534,2583,2587,2552,2553,2554,2555,2580,2581,2582,2573,2575,2584,495,499,500,501,502,504,505,506,507,511,514,520,521,524,2478,2479,2574,7465,8659,8735,2571,2572,2507,2522,2528,2542,2543,2544,2545,2562,2535,516,510,850,503,513,497,518,512,509,525,508,523,498,526,522,519,5389,2606,2613,2614,2615,2609,2601,2602,2603,2619,2598,2599,2600,2639,2640,2627,2628,2629,2630,7455,2631,2632,2633,2634,2625,2626,2596,2623,2617,2618,2610,2593,2594,2595,2616,2612,2622,2588,2589,2590,7519,2611,8734,2576,2577,2578,3407,2638,532,493,533,536,537,538,543,544,546,547,549,555,556,2560,2565,2568,3403,7521,7565,8660,7669,2636,2637,2607,2608,7518,540,561,528,548,527,541,545,1520,562,558,551,2726,535,559,560,554,550,529,530,542,557,531,553,563,552,2725,2597,2624,2729,2733,2734,2648,2649,2650,2651,2653,2655,3501,2731,2732,2662,2663,2664,2665,2666,2667,3413,2668,2669,2585,2680,2681,2682,2683,7522,2720,5631,2711,2712,2704,2705,7520,2728,2690,2691,2687,2706,2707,2686,2703,2737,2670,2672,2673,2674,2675,2676,2677,2678,2679,8694,2684,2685,2697,2699,2700,2701,2723,2657,2658,2659,2644,2645,2646,2647,2709,2710,2718,2719,2694,2695,2696,7731,515,539,565,567,569,570,574,583,586,588,590,591,592,594,598,601,605,606,3408,3410,3412,3414,3416,7617,2708,2689,2738,2714,2715,3409,577,566,580,568,589,602,579,572,593,603,575,585,604,578,571,596,8884,599,582,581,595,584,2620,2749,2750,2751,2752,2754,2755,2740,7730,2804,2803,7670,2794,2830,2831,2832,2833,2835,2836,2837,2820,2821,2795,2796,5935,2845,2806,2807,2808,8661,2839,2743,2744,2745,2824,2825,2826,2828,2829,2814,2815,2778,2779,2756,2767,2768,2769,2780,2781,2782,2783,2785,2786,2805,2809,2811,2812,2747,2748,2842,2843,2765,2800,2838,2763,2788,2789,2790,2791,2792,2775,2776,2777,2801,2802,2753,2758,2759,2760,2813,7672,2772,2773,2774,7524,3418,608,609,610,611,612,613,615,621,622,626,627,628,631,634,635,637,638,640,2661,2688,2717,3237,3415,3439,3440,3441,3442,3443,3444,3445,3446,7456,7477,2770,2771,8895,2742,2834,2799,2840,629,630,623,619,851,618,633,644,624,632,617,625,641,923,645,643,616,639,2846,2851,2852,2853,3496,2860,2861,2862,2848,7566,7732,2917,2918,2910,2915,7619,7620,8662,2897,2898,2899,2900,3423,3522,2864,2865,7527,2889,2890,2901,7451,2911,2913,2867,2868,2869,2881,2882,2883,2885,2887,2888,5633,7618,2896,8697,2855,2856,2857,2884,2916,2870,2871,2874,2875,7525,2920,2921,2922,2894,2923,2908,2909,2924,2925,8737,2891,7526,2879,2880,3714,3715,3716,2876,3406,7675,646,648,649,651,653,655,656,657,659,661,665,666,667,669,673,2621,2764,2766,3420,3436,3437,3450,3448,3449,3451,3452,4877,5717,6237,7678,7679,7735,8738,8896,8897,2919,2877,2878,2902,2903,2905,2906,664,668,660,677,662,672,654,674,670,671,650,663,2947,2949,2944,2927,3479,2969,2970,2981,2956,2957,2945,2946,2952,2953,8800,2938,2939,8663,2968,2935,2936,7736,2951,2931,2973,2987,2975,2942,2976,7622,2982,2983,2984,2965,2963,2964,2954,2955,2934,8695,2971,2972,2985,2986,3430,3435,573,678,680,691,693,698,700,701,704,706,855,703,689,3427,3429,3431,3432,3433,3434,3454,3455,3458,3459,3460,3463,3464,3466,3467,3468,3918,4848,5934,7531,7569,8699,2977,3425,7567,2958,2959,2960,2961,2962,4849,7461,2988,2989,2978,2979,2980,8698,685,686,688,687,697,702,696,684,681,692,694,3004,3006,2994,2997,2998,3000,3010,3030,3031,3032,3029,3058,3059,3060,3063,3038,3039,3041,3043,3053,8740,3071,3072,3077,3078,3079,3081,3055,3056,3057,7474,7624,3044,3045,3074,3075,3076,3067,3068,3070,8739,3864,3023,3011,3051,3001,3003,3064,3025,8814,3035,3036,3037,3048,983,712,716,718,719,723,730,731,732,733,734,736,854,857,2823,3476,3469,3471,3473,3474,3477,3483,3514,7571,3054,3017,3018,3020,3021,3013,3014,3016,7737,2990,2991,708,728,714,725,715,739,858,709,737,717,1048,2816,3115,3116,3130,3105,3117,3119,3120,3122,7149,3107,3109,8701,3112,3138,3090,3139,3093,3094,3095,3096,3472,7475,3803,3140,3141,738,3148,3123,3125,3126,3127,7682,3102,3104,3150,3152,3153,7532,8741,3157,3101,3158,3088,7464,3106,4162,4164,4165,3134,3135,3136,3426,3481,744,713,740,745,747,752,753,756,761,762,763,764,766,767,768,769,770,774,913,3024,3480,3506,3484,3485,3487,3491,3492,3493,4129,8803,3091,4163,3082,3085,3087,3103,7684,7740,3151,3154,3143,3144,3145,3146,751,742,743,749,758,760,772,771,741,765,773,748,754,759,3166,7628,3219,3192,7536,3184,3207,8743,8744,3181,7534,3210,3211,3212,3214,3421,3204,3205,3217,3097,3208,3209,3233,3236,3167,3169,3222,3223,3225,3185,3186,3218,3708,3924,3172,3174,3175,3176,3194,3180,7472,3201,3202,3717,3177,3178,3179,3165,3230,3231,3232,7575,3564,3227,7743,3189,3191,3114,791,775,777,779,781,782,783,784,785,786,787,788,790,794,796,807,808,809,812,2817,2818,2819,3108,3132,3284,3456,3505,3512,3490,3498,3500,3504,3507,3510,3949,4354,7466,7489,7493,7497,7577,7630,7631,7689,7745,8745,3163,3164,3228,3187,3193,3200,3215,3216,778,804,780,801,793,811,805,799,789,810,802,795,3254,3238,3242,3243,3255,3256,3281,3283,3250,3251,3262,3264,3265,3245,8815,3260,3261,7687,3258,3259,3267,3276,3277,3266,3313,3268,3314,3292,3293,3294,3295,3296,7690,3288,3289,3270,3272,3306,3307,3308,3309,3311,3892,3248,3280,3282,3300,3305,3552,3561,726,817,818,819,820,821,822,827,828,830,833,834,841,844,845,846,847,849,852,3098,3518,3516,3517,3521,3560,3550,3553,3555,3557,3558,3559,3563,3566,3925,3950,7693,7750,8668,3252,3297,3298,3301,3302,3303,3304,3279,7746,843,840,813,848,829,823,832,814,816,824,825,839,3375,3361,3372,3373,3374,7452,3328,3329,3331,3339,3365,3366,3367,3389,3323,3325,3370,3344,7537,7634,3398,3399,3337,3926,3382,3383,3384,3352,3353,3371,3340,3341,3342,7581,3394,3391,3424,3385,3386,3387,3368,7504,3350,3351,7457,3379,3380,3400,7691,3345,3347,3357,3359,3360,3320,3321,3322,872,859,861,863,865,866,868,870,877,878,879,880,881,886,887,894,895,884,3290,3515,3548,3554,3568,3569,3574,3570,3573,3580,3578,3581,7576,7583,8667,8746,3326,3327,3388,3377,7498,860,3618,862,891,876,883,885,3605,3606,3607,892,3608,3610,3600,7751,8705,893,3630,3631,3632,3633,867,3592,3598,3599,890,3530,3635,3604,3603,3591,3903,3536,3620,3622,3602,3615,3628,3634,3614,3541,7538,3637,3626,3643,3645,3646,3542,3546,3547,3585,3587,3524,3525,3594,3595,3619,3616,898,899,900,907,908,916,917,3034,3129,910,3395,3397,3497,3650,3653,3880,3883,3884,3885,3886,3887,3888,3889,3890,3909,3927,3944,3945,3710,7541,896,897,7585,903,906,918,919,920,921,922,924,925,3882,3946,8706,8750,3532,3534,3537,3527,3528,3529,912,914,915,926,911,3660,3661,3668,3671,3656,3657,3658,3659,3672,3673,8805,3913,3663,7584,3688,3678,3679,3680,7539,7639,3919,3684,3685,3724,3725,3726,3686,3721,3723,3682,3700,3697,3698,3692,3694,3676,3704,3705,931,944,945,947,951,952,953,954,956,933,934,3596,3893,3894,3898,3899,3901,3902,3905,3906,5501,928,932,935,936,937,938,948,7697,939,940,942,943,3895,3904,7540,3664,3666,3667,3712,3713,7753,3696,3718,3740,3742,3789,3791,3780,3732,3733,3737,3738,3747,3752,5983,3763,8670,949,3746,8707,3754,3759,3760,957,3758,2083,3744,3943,3768,3769,3770,3771,3772,3776,3756,3762,8751,3784,3785,3786,3778,3779,3764,3765,3731,3795,3796,3777,964,975,978,989,980,982,988,990,993,970,971,962,969,994,984,986,987,961,966,967,3584,3720,3907,3910,3911,3914,3915,3916,3917,3920,3921,3929,3931,7469,7587,7277,7278,7280,3781,3739,3774,3775,979,3840,3851,7545,3818,3820,3821,3822,3844,8671,977,3830,3853,3854,974,3828,3832,3833,7698,960,963,3843,3879,7476,3869,3948,3858,3859,3871,3951,4374,3815,3816,3860,3872,3952,3802,3827,3835,3836,3837,3865,3845,3846,3848,3856,3857,3861,3829,3852,1001,1004,1014,1025,995,1021,1022,1024,1000,1002,1003,1005,1006,996,976,1011,1020,1027,1412,998,3933,3935,3936,3937,3941,3996,3850,3824,3825,7586,3799,3873,3874,3875,3878,997,1019,1017,1008,3823,4025,3971,3972,3973,3970,4010,3978,3981,3953,3954,3955,3958,7548,4013,4014,4015,4005,4008,3983,3961,3963,7546,5366,3999,4000,4002,4003,4004,3988,3990,3997,3998,4001,3974,4027,3991,3992,3993,3966,4028,4030,4031,5807,5809,5812,4044,1032,1041,1042,1051,1030,1031,1034,1053,1037,1047,1054,1056,1049,8838,4051,4052,4053,4054,4055,4056,4057,4058,4059,4061,4063,4071,4060,4099,4107,4105,4142,4361,4362,7151,7645,7699,7704,8807,8840,4011,7643,4033,7758,4009,4045,4037,4038,4039,4041,3797,5808,4018,4019,4020,4021,4022,4023,4024,7590,4046,4047,4048,4049,1044,1045,1046,1039,1033,1052,1043,1040,4081,4082,4085,7592,4144,4159,4160,4100,4127,4095,4097,4098,7479,4351,4352,4077,4080,4132,4133,7760,4103,4108,4109,7454,4088,4087,4121,4125,4126,8853,8849,8851,4115,4116,4118,4155,4156,4157,4136,4128,4064,4066,4151,7549,1063,1064,1068,1069,1071,1077,1081,1082,1083,1057,1060,1062,1084,1088,1122,1061,1067,1074,1076,1078,7695,1058,1080,4176,4184,4206,4214,4239,4246,7550,4090,4091,4111,4137,4138,4139,4140,4078,1059,1073,1121,4248,4249,4250,4251,4253,4208,4209,4191,4207,4240,4368,4244,4180,4193,5810,7552,4141,4228,4229,4170,4171,4173,4167,4196,4242,7647,4219,4198,4200,4358,1098,1090,1094,1096,1097,1099,1103,1105,1106,1107,1112,1113,1101,1102,1111,1115,1100,1108,1109,1116,1117,1118,1119,4114,4264,4293,4294,4303,4312,4353,4366,4344,4356,4357,4364,4365,4233,4234,4235,4236,4238,7480,4230,4231,4232,4183,7761,1092,1091,1104,1089,4254,4256,4291,7707,4258,4259,4260,4338,4343,4266,4267,4268,4309,4304,4306,4318,4320,4321,4334,4335,4336,4337,4279,4282,4269,4323,4313,4314,4315,4316,4265,4288,4289,7648,7705,8675,4295,4297,7553,4299,4300,4301,4263,1129,1130,1142,1151,1153,1154,1128,1132,1136,1146,1147,1148,1149,1134,1135,1137,1138,4360,4381,4382,4384,4386,4387,4388,4391,4392,4393,4394,4396,4397,4398,4399,7481,8712,4296,4345,4284,1152,1140,1133,1144,1123,1124,1150,4428,4416,4433,4434,4435,4450,4440,4462,4463,4476,4458,4459,4460,4461,4471,4475,4420,4423,4408,4442,4403,4406,4468,4448,4481,1155,1159,1169,1171,1172,1179,1180,1177,1178,1164,1166,1173,1174,1175,1157,8859,4319,4480,4482,4484,4485,4839,4841,4842,4843,4844,4846,7467,4421,8888,4378,1165,1163,1160,1183,1161,1168,4500,4502,4503,4445,7650,4498,4505,4494,4495,4496,4492,4509,4510,4544,4525,4560,4546,4547,4539,4562,4535,8898,4548,4488,4489,4491,4867,4571,1192,1211,1210,1200,1205,4583,1196,1213,1212,7765,1198,1197,1214,1207,1191,4581,4856,4860,4852,4853,4582,4855,4854,4851,4527,4528,4529,4530,4532,4570,4591,4516,4517,4518,1188,1186,1204,4613,8754,4595,4598,4599,4601,4608,4620,4621,4604,4610,4612,7506,7508,4633,4635,4603,4605,4639,8678,4636,4622,4626,4643,4651,4646,4640,4576,4584,4630,4587,4602,4657,4866,1228,1233,1237,1239,1240,1229,1226,1247,1246,1234,1241,4865,4660,1224,1231,1242,1236,1243,1230,8899,4666,4659,4658,4662,4869,4870,4588,4589,4590,1217,1221,1220,4692,4693,8715,4694,4689,4691,4688,4697,4702,4713,4718,4719,4720,4707,4715,4730,4736,4737,4738,4756,4734,4735,4762,4743,4753,4758,4759,4677,4678,4679,4680,4682,4683,4654,4725,4727,4728,4873,1269,1277,1266,1280,1250,1248,1273,1254,1274,1255,4872,4875,7712,7713,8860,4672,4673,4674,4675,4676,7599,7653,4686,8679,1265,1256,1268,4745,4746,4748,4749,4750,4569,7767,4781,4782,4802,4804,4822,4823,4826,4836,4831,4778,7600,4829,8905,4775,4817,4799,4793,1288,1285,1289,1291,8717,1308,1312,1313,1309,4977,4964,4985,1290,1302,1304,4884,4949,4986,4938,4969,4972,4976,4791,4805,4806,4807,4808,4770,4801,1297,1283,1284,4939,7602,4963,4992,4993,4917,4919,4955,4956,4958,4959,4965,4888,4930,4931,4950,4952,4953,4954,7715,4943,4902,4946,4971,4940,4906,1322,1340,1321,1323,1325,1345,1331,1334,1335,1336,1342,1316,1318,1327,5103,5015,5045,5046,5096,5042,5008,5104,5016,7770,4897,4980,4982,4983,1314,1320,5072,5073,8718,5020,5021,5048,5074,5077,5093,5094,5031,5089,5019,5079,5053,5007,5099,5100,1372,1357,1361,1369,5196,1374,5197,1348,1349,1362,1367,1368,1370,1364,1359,1350,1353,1351,8757,5140,5205,5160,5159,5203,5195,5136,5204,5135,5388,5392,5055,5058,5059,5039,1347,1363,1346,5186,5120,5125,5126,5209,5210,5145,5130,5133,5143,5187,5178,5179,5180,8758,5182,5175,5176,5177,5206,5207,5208,5156,5167,5168,5163,5193,5189,5162,7468,5115,5075,5260,5265,7501,1397,1409,1401,1400,1410,1408,1398,1405,1388,1403,1406,1407,1380,5078,5230,5263,5395,5273,5393,5264,5198,5199,5502,5014,1381,5237,5238,1393,5247,1379,5294,5293,5241,7470,7604,5256,5257,5223,5224,5282,5252,5254,5236,5250,5228,5234,5235,5270,5231,5271,5267,5244,5246,5215,5349,5399,1429,1427,5350,1413,1425,1433,1442,1438,1436,5181,7500,5117,5291,5166,5320,1415,1440,5296,5376,5312,5302,5303,5304,5369,5378,5382,5359,5360,5330,5331,5326,5328,5334,5346,5317,5318,5319,1468,5424,5703,5706,1446,5398,1452,1474,1450,5415,5403,5701,7720,5329,5316,5352,5353,5354,1448,1444,1454,1443,1445,5435,5437,5438]);


//////////////////////////////////////////////////////////////////////////////////////////////////////////////
let M = null;
function processPage({assignments, reviews, subjects}) {
    const t1 = elapsed();
    M = {assignments, reviews, subjects};
    const assigns = [...assignments.values()].filter(a => !a.hidden && subjects.get(a.subject_id).level <= 46);

    // Review stats for the last 25 hours
    const day_ago = new Date((new Date).getTime() - 1000*60*60*25).toISOString();


    let total = 0;
    let total_correct = 0;
    let prevburned = 0;
    let prevburned_correct = 0;

    for (const [id, data] of reviews) {
        if (data.created_at < day_ago) {continue}
        const correct = !(data.incorrect_reading_answers + data.incorrect_meaning_answers);

        total++;
        if (correct) {
            total_correct++;
        }
        if (prevburned_set.has(data.subject_id)) {
            prevburned++;
            if (correct) {
                prevburned_correct++;
            }
        }
    }


    // Bucket counts (apprentice, guru, etc.)
    const counts = [0,0,0,0,0,0,0,0,0,0];
    for (const {srs_stage} of assigns) {
        counts[srs_stage]++;
    }

    const now = new Date().toISOString();
    const review_count = assigns.filter(a => a.available_at && a.available_at <= now).length;
    const week_from_now = new Date((new Date).getTime() + 1000*60*60*24*7).toISOString();
    const review_count2 = assigns.filter(a => a.available_at && a.available_at <= week_from_now).length;
    const month_from_now = new Date((new Date).getTime() + 1000*60*60*24*30).toISOString();
    const review_count3 = assigns.filter(a => a.available_at && a.available_at <= month_from_now).length;

    const out = document.getElementById('results');
    const write = s => out.appendChild(document.createTextNode(s));

    write(`\n${(new Date).toDateString()}:`);
    write(`\nTime spent: ---`);
    write(`\nReviews completed: ${total}`);
    write(`\nReviews remaining: ${review_count}`);
    write(`\nReviews in next week: ${review_count2} (+${review_count2-review_count})`);
    write(`\nReviews in next month: ${review_count3} (+${review_count3-review_count2})`);
    if (total) {
        write(`\nAccuracy: ${(100*total_correct/total).toFixed(2)}% (${total_correct}/${total})`);
    }

    const apprentice = counts[1] + counts[2] + counts[3] + counts[4];
    const guru = counts[5] + counts[6];
    write(`\n\nCurrent item counts:`);
    write(`\nApprentice: ${apprentice}\nGuru: ${guru}\nMaster: ${counts[7]}\nEnlightened: ${counts[8]}\nBurned: ${counts[9]}`);


    {
        const counts = [0,0,0,0,0,0,0,0,0,0];
        for (const {srs_stage, subject_id} of assigns) {
            if (!prevburned_set.has(subject_id)) {continue}
            counts[srs_stage]++;
        }

        const apprentice = counts[1] + counts[2] + counts[3] + counts[4];
        const guru = counts[5] + counts[6];
        write(`\n\nResurrected item counts:`);
        write(`\nRes-Apprentice: ${apprentice}\nRes-Guru: ${guru}\nRes-Master: ${counts[7]}\nRes-Enlightened: ${counts[8]}\nRes-Burned: ${counts[9]}`);
    }

    console.log(`processPage ${t1} ${elapsed() - t1}`);

}
</script>
